<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="15">
    <title>Atendimento - Colaborador</title>
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/atendimento.css}">
</head>
<body>
    <header>
        <nav>
            <div class="logo">üë®‚Äçüíº Painel de Atendimento</div>
            <div class="nav-links">
                <span class="colaborador-info-discreta" th:if="${colaboradorLogado != null}">
                    <span th:text="${colaboradorLogado.nome}">Jo√£o Silva</span>
                </span>
                <a href="/login">Trocar Usu√°rio</a>
                <a href="/senhas">Ver Senhas</a>
            </div>
        </nav>
    </header>

    <div class="container">
        <div class="alert alert-info">
            <strong>üîÑ Atualiza√ß√£o Autom√°tica:</strong> Esta p√°gina √© atualizada automaticamente a cada 15 segundos.
        </div>

        <!-- Estado: Nenhum atendimento -->
        <div th:unless="${temAtendimentos}" class="empty-state-full">
            <div class="icon-large">üíº</div>
            <h2>Nenhum atendimento dispon√≠vel</h2>
            <p>N√£o h√° senhas aguardando atendimento no momento.</p>
        </div>

        <!-- Estado: Tem atendimentos dispon√≠veis -->
        <div th:if="${temAtendimentos}" class="atendimento-main">
            
            <!-- FASE 1: Senha em Atendimento (EM_ATENDIMENTO) - Prioridade M√°xima -->
            <div th:if="${senhaEmAtendimento != null}" class="atendimento-em-andamento">
                <div class="card-header">
                    <h2 class="card-title">üë®‚Äçüíº Atendimento em Andamento</h2>
                    <span class="badge-status em-atendimento">EM ATENDIMENTO</span>
                </div>
                
                <div class="senha-display-large">
                    <div class="senha-codigo-large" th:text="${senhaEmAtendimento.senha}">NA001</div>
                    <div class="senha-info-large">
                        <div class="info-row">
                            <span class="label">Tipo:</span>
                            <span class="badge-tipo" 
                                  th:classappend="${senhaEmAtendimento.tipoSecao == 'PRIORITARIA'} ? prioritaria : normal"
                                  th:text="${senhaEmAtendimento.tipoSecao}">NORMAL</span>
                        </div>
                        <div class="info-row" th:if="${senhaEmAtendimento.guicheChamada != null}">
                            <span class="label">Chamada em:</span>
                            <span th:text="${senhaEmAtendimento.guicheChamada}">Guich√™ 1</span>
                        </div>
                    </div>
                </div>

                <div class="acoes-atendimento">
                    <!-- Finalizar Atendimento -->
                    <form th:action="@{/atendimento/finalizar}" method="post" class="acao-form">
                        <input type="hidden" th:name="idSecao" th:value="${senhaEmAtendimento.id}">
                        <div class="form-group">
                            <label for="descricao">Descri√ß√£o do Atendimento</label>
                            <textarea id="descricao" name="descricao" placeholder="Descreva o atendimento realizado..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success btn-large">‚úÖ Finalizar Atendimento</button>
                    </form>

                    <!-- Transferir Atendimento -->
                    <form th:action="@{/atendimento/transferir}" method="post" class="acao-form">
                        <input type="hidden" th:name="idSecao" th:value="${senhaEmAtendimento.id}">
                        <div class="form-group">
                            <label for="departamentoDestinoId">Transferir para Departamento ID</label>
                            <input type="number" id="departamentoDestinoId" name="departamentoDestinoId" placeholder="Ex: 2" required>
                        </div>
                        <div class="form-group">
                            <label for="descricao_transf">Motivo da Transfer√™ncia</label>
                            <textarea id="descricao_transf" name="descricao" placeholder="Por que est√° transferindo?" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-danger btn-large">üîÑ Transferir Atendimento</button>
                    </form>
                </div>
            </div>

            <!-- FASE 2: Senha Chamada (CHAMADA) - Aguardando Confirma√ß√£o -->
            <div th:if="${senhaEmAtendimento == null && senhaChamada != null}" class="senha-chamada-aguardando">
                <div class="card-header">
                    <h2 class="card-title">üì¢ Senha Chamada - Aguardando Confirma√ß√£o</h2>
                    <span class="badge-status chamada">CHAMADA</span>
                </div>
                
                <div class="senha-display-large">
                    <div class="senha-codigo-large" th:text="${senhaChamada.senha}">NA001</div>
                    <div class="senha-info-large">
                        <div class="info-row">
                            <span class="label">Tipo:</span>
                            <span class="badge-tipo" 
                                  th:classappend="${senhaChamada.tipoSecao == 'PRIORITARIA'} ? prioritaria : normal"
                                  th:text="${senhaChamada.tipoSecao}">NORMAL</span>
                        </div>
                        <div class="info-row" th:if="${senhaChamada.guicheChamada != null}">
                            <span class="label">Chamada em:</span>
                            <span th:text="${senhaChamada.guicheChamada}">Guich√™ 1</span>
                        </div>
                    </div>
                </div>

                <div class="confirmacao-acoes">
                    <div class="alerta-confirmacao">
                        <strong>‚ö†Ô∏è Aguardando confirma√ß√£o:</strong> O paciente apareceu no guich√™?
                    </div>
                    <div class="btn-group-confirmacao">
                        <form th:action="@{/atendimento/iniciar}" method="post" style="flex: 1;">
                            <input type="hidden" th:name="idSecao" th:value="${senhaChamada.id}">
                            <button type="submit" class="btn btn-success btn-large">‚úÖ Sim, Cliente Presente - Iniciar Atendimento</button>
                        </form>
                        <form th:action="@{/atendimento/cancelar-chamada}" method="post" style="flex: 1;">
                            <input type="hidden" th:name="idSecao" th:value="${senhaChamada.id}">
                            <button type="submit" class="btn btn-secondary btn-large">‚ùå Cliente N√£o Compareceu - Cancelar Chamada</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- FASE 3: Senhas Aguardando (AGUARDANDO) - Para Chamar -->
            <div th:if="${senhaEmAtendimento == null && senhaChamada == null && !#lists.isEmpty(senhasAguardando)}" class="senhas-aguardando-section">
                <div class="section-header">
                    <h2 class="section-title">üìã Senhas Aguardando Atendimento</h2>
                    <span class="badge-count" th:text="${#lists.size(senhasAguardando)}">0</span>
                </div>

                <div class="senhas-grid">
                    <div class="senha-item-card" th:each="senha : ${senhasAguardando}">
                        <div class="senha-header-card">
                            <div class="senha-numero" th:text="${senha.senha}">NA001</div>
                            <span class="senha-tipo-badge" 
                                  th:classappend="${senha.tipoSecao == 'PRIORITARIA'} ? prioritaria : normal"
                                  th:text="${senha.tipoSecao}">NORMAL</span>
                        </div>
                        <div class="senha-info-card">
                            <div class="info-line">
                                <span class="info-label">Status:</span>
                                <span class="status-badge" th:text="${senha.status}">AGUARDANDO</span>
                            </div>
                        </div>
                        <div class="senha-actions-card">
                            <form th:action="@{/atendimento/chamar}" method="post">
                                <input type="hidden" th:name="idSecao" th:value="${senha.id}">
                                <div class="form-group-inline">
                                    <input type="text" name="guiche" placeholder="Guich√™ (opcional)" class="input-guiche">
                                </div>
                                <button type="submit" class="btn btn-primary btn-full">üì¢ Chamar para a Sala</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
